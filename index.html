<!-- dashboard.html
     Host this file on GitHub Pages (HTTPS).
     Works with Wix postMessage bridge:
       - Sends: { type:"GET_ORDERS", payload:{tab,q,limit,offset} }
       - Receives: { type:"ORDERS_RESULT", items: [...] } or { type:"ERROR", message:"..." }
       - Sends updates: { type:"SET_URGENCY", id, value, payload:{...state} }
       - (Optional for later) Sends transfers: { type:"TRANSFER_ORDER", id, toSite, reason, note, payload:{...state} }
-->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Orders Dashboard</title>
  <style>
    :root{
      --bg:#ffffff;
      --text:#111;
      --muted:#6b7280;
      --line:#e5e7eb;
      --header:#0b0b0b;
      --headerText:#fff;
      --chipBg:#f3f4f6;
      --focus:#2563eb;
      --danger:#b91c1c;
    }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg);
      color:var(--text);
    }
    .wrap{ padding:18px 22px; }

    /* Top bar */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      margin-bottom:12px;
      flex-wrap:wrap;
    }
    .tabs{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .tab{
      border:1px solid var(--line);
      background:#fff;
      padding:10px 14px;
      border-radius:999px;
      cursor:pointer;
      font-weight:700;
      color:#111;
      user-select:none;
    }
    .tab.active{
      border-color:#111;
      background:#111;
      color:#fff;
    }

    .controls{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-left:auto;
    }
    .search{
      width:320px;
      max-width:72vw;
      border:1px solid var(--line);
      padding:10px 12px;
      border-radius:10px;
      outline:none;
    }
    .search:focus{
      border-color:var(--focus);
      box-shadow:0 0 0 3px rgba(37,99,235,.15);
    }
    .btn{
      border:1px solid var(--line);
      background:#fff;
      padding:10px 12px;
      border-radius:10px;
      cursor:pointer;
      font-weight:700;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .btn:hover{ border-color:#cbd5e1; }

    /* Table */
    .tableWrap{
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      table-layout:fixed;
    }
    thead th{
      position:sticky;
      top:0;
      background:var(--header);
      color:var(--headerText);
      text-align:left;
      font-weight:800;
      font-size:13px;
      padding:12px 12px;
      border-bottom:1px solid #000;
      z-index:2;
      white-space:nowrap;
    }
    tbody td{
      padding:12px 12px;
      border-bottom:1px solid var(--line);
      font-size:13px;
      vertical-align:middle;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    tbody tr:hover{ background:#fafafa; }

    /* Chips / badges */
    .chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      background:var(--chipBg);
      font-weight:800;
      font-size:12px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      padding:6px 10px;
      border-radius:999px;
      font-weight:800;
      font-size:12px;
      border:1px solid var(--line);
      background:#fff;
    }
    .badge.red{ border-color: rgba(185,28,28,.35); background: rgba(185,28,28,.06); color: var(--danger); }
    .badge.green{ border-color: rgba(22,163,74,.35); background: rgba(22,163,74,.06); color: #166534; }
    .badge.gray{ border-color: rgba(107,114,128,.35); background: rgba(107,114,128,.06); color: #374151; }

    /* Urgency dropdown */
    .urgSel{
      width:128px;
      border:1px solid var(--line);
      padding:8px 10px;
      border-radius:10px;
      background:#fff;
      font-weight:800;
      cursor:pointer;
    }
    .urgSel:focus{
      outline:none;
      border-color:var(--focus);
      box-shadow:0 0 0 3px rgba(37,99,235,.15);
    }

    /* Footer/paging */
    .footer{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 2px 0;
      color:var(--muted);
      font-size:12px;
      flex-wrap:wrap;
    }
    .loading{ opacity:.65; pointer-events:none; }
    .muted{ color:var(--muted); }

    /* Column widths (adjust as you like) */
    colgroup col.cUrg{ width:150px; }
    colgroup col.cOrder{ width:150px; }
    colgroup col.cCust{ width:160px; }
    colgroup col.cPre{ width:140px; }
    colgroup col.cPhone{ width:140px; }
    colgroup col.cPay{ width:120px; }
    colgroup col.cCreated{ width:160px; }
    colgroup col.cTotal{ width:110px; }
    colgroup col.cRecv{ width:140px; }
    colgroup col.cStatus{ width:150px; }
    colgroup col.cPickup{ width:150px; }

    /* Small screens */
    @media (max-width: 900px){
      .wrap{ padding:14px; }
      colgroup col.cCreated{ width:140px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="tabs" aria-label="Tabs">
        <div class="tab active" data-tab="TST">TST</div>
        <div class="tab" data-tab="CENTRAL">Central</div>
        <div class="tab" data-tab="ADMIN">Admin / All</div>
      </div>

      <div class="controls">
        <input id="search" class="search" placeholder="Search: order # / name / phone" />
        <button id="refresh" class="btn" type="button">Refresh</button>
      </div>
    </div>

    <div class="tableWrap" id="tableWrap">
      <table>
        <colgroup>
          <col class="cUrg"><col class="cOrder"><col class="cCust"><col class="cPre"><col class="cPhone">
          <col class="cPay"><col class="cCreated"><col class="cTotal"><col class="cRecv"><col class="cStatus"><col class="cPickup">
        </colgroup>
        <thead>
          <tr>
            <th>Urgency</th>
            <th>Order Number</th>
            <th>Customer</th>
            <th>Pre-Consult</th>
            <th>Phone</th>
            <th>Payment</th>
            <th>Created At</th>
            <th>Total</th>
            <th>Receive Method</th>
            <th>Order Status</th>
            <th>Pick Up Location</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="footer">
      <div id="meta">0 orders</div>
      <div class="muted" id="hint">Tip: change urgency directly in the dropdown.</div>
    </div>
  </div>

  <script>
    // -------- State --------
    const state = {
      tab: "TST",
      q: "",
      limit: 50,
      offset: 0
    };

    const tbody = document.getElementById("tbody");
    const tableWrap = document.getElementById("tableWrap");
    const meta = document.getElementById("meta");
    const search = document.getElementById("search");

    function setLoading(on){
      tableWrap.classList.toggle("loading", !!on);
    }

    function post(msg){
      // Wix HTML iframe listens via onMessage/postMessage bridge
      window.parent.postMessage(msg, "*");
    }

    function requestOrders(){
      setLoading(true);
      post({ type:"GET_ORDERS", payload: { ...state } });
    }

    // -------- UI handlers --------

    // Tabs
    document.querySelectorAll(".tab").forEach(el => {
      el.addEventListener("click", () => {
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        el.classList.add("active");
        state.tab = el.dataset.tab;
        state.offset = 0;
        requestOrders();
      });
    });

    // Search (debounced)
    let timer = null;
    search.addEventListener("input", (e) => {
      clearTimeout(timer);
      timer = setTimeout(() => {
        state.q = e.target.value || "";
        state.offset = 0;
        requestOrders();
      }, 250);
    });

    document.getElementById("refresh").addEventListener("click", () => requestOrders());

    // -------- Formatting --------
    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[m]));
    }

    function fmtDate(d){
      if(!d) return "";
      try{
        const dt = new Date(d);
        return dt.toLocaleString();
      }catch(_){ return String(d); }
    }

    function fmtTotal(x){
      if(x === null || x === undefined || x === "") return "";
      const n = Number(x);
      if(Number.isNaN(n)) return String(x);
      return n.toFixed(2);
    }

    function chip(text){
      return `<span class="chip">${escapeHtml(text || "")}</span>`;
    }

    function paymentBadge(paymentStatus){
      const s = String(paymentStatus || "").toUpperCase();
      if (s === "PAID") return `<span class="badge green">PAID</span>`;
      if (s === "UNPAID") return `<span class="badge red">UNPAID</span>`;
      if (s.includes("REFUND")) return `<span class="badge gray">${escapeHtml(s)}</span>`;
      return `<span class="badge gray">${escapeHtml(s || "-")}</span>`;
    }

    function urgencySelect(order){
      const current = String(order.urgencyFinal || "NORMAL").toUpperCase();
      const id = order._id;
      return `
        <select class="urgSel" data-id="${escapeHtml(id)}">
          <option value="ASAP" ${current==="ASAP" ? "selected":""}>ASAP</option>
          <option value="TODAY" ${current==="TODAY" ? "selected":""}>TODAY</option>
          <option value="NORMAL" ${current==="NORMAL" ? "selected":""}>NORMAL</option>
        </select>
      `;
    }

    // -------- Render --------
    function renderRows(items){
      tbody.innerHTML = (items || []).map(o => {
        return `
          <tr>
            <td>${urgencySelect(o)}</td>
            <td title="${escapeHtml(o.orderNumber)}">${chip(o.orderNumber)}</td>
            <td title="${escapeHtml(o.customerName)}">${escapeHtml(o.customerName || "")}</td>
            <td>${escapeHtml(o.preConsultStatus || "")}</td>
            <td>${escapeHtml(o.phoneDigits || o.phoneNorm || "")}</td>
            <td>${paymentBadge(o.paymentStatus)}</td>
            <td>${escapeHtml(fmtDate(o.createdAt))}</td>
            <td>${escapeHtml(fmtTotal(o.total))}</td>
            <td>${escapeHtml(o.fulfillmentType || "")}</td>
            <td>${escapeHtml(o.orderStatusFinal || "")}</td>
            <td>${escapeHtml(o.pickupLocation || "")}</td>
          </tr>
        `;
      }).join("");

      // Attach urgency listeners after render
      tbody.querySelectorAll("select.urgSel").forEach(sel => {
        sel.addEventListener("change", (e) => {
          const id = e.target.dataset.id;
          const value = e.target.value;

          post({
            type: "SET_URGENCY",
            id,
            value,
            payload: { ...state } // keep same view
          });
        });
      });
    }

    // -------- Receive messages from Wix page code --------
    window.addEventListener("message", (event) => {
      const msg = event.data || {};

      if (msg.type === "ORDERS_RESULT") {
        setLoading(false);
        const items = msg.items || [];
        renderRows(items);
        meta.textContent = `${items.length} orders`;
      }

      if (msg.type === "ERROR") {
        setLoading(false);
        alert(msg.message || "Unknown error");
      }
    });

    // Initial load
    requestOrders();
  </script>
</body>
</html>
